---
import { X, Phone, ChevronDown } from "@lucide/astro";

import LogoInline from "./LogoInline.astro";
import Button from "../ui/Button.astro";

const pathname = Astro.url.pathname;

const isActive = (href: string) => {
  if (href === "/") return pathname === "/";
  return pathname === href || pathname.startsWith(href + "/");
};

const subLinks = [
  { href: "/sluzby/elektroinstalace", label: "Elektroinstalace" },
  { href: "/sluzby/revize", label: "Revize" },
  { href: "/sluzby/opravy-montaze", label: "Opravy a montáže" },
];

const links = [
  { href: "/o-nas", label: "O nás" },
  { href: "/reference", label: "Reference" },
  { href: "/kontakt", label: "Kontakt" },
];
---

<div
  class="group fixed inset-0 z-[100] pointer-events-none lg:hidden"
  id="mobile-menu-v2"
  data-open="false"
>
  <div
    class="absolute inset-0 bg-neutral-800/90 opacity-0 transition-opacity duration-300 group-data-[open=true]:opacity-100 group-data-[open=true]:pointer-events-auto backdrop-blur-sm"
    data-menu-backdrop
  >
  </div>

  <div
    class="absolute inset-0 translate-y-full bg-background transition-transform duration-300 ease-out group-data-[open=true]:translate-y-0 group-data-[open=true]:pointer-events-auto overflow-y-auto"
  >
    <div class="container min-h-full flex flex-col py-6">
      <!-- Header -->
      <div class="flex items-center justify-between">
        <LogoInline class="w-40" dark={true} />
        <button
          type="button"
          aria-label="Zavřít menu"
          data-menu-close
          class="p-2 -m-2 text-neutral-800/95"
        >
          <X class="h-6 w-6" />
        </button>
      </div>

      <div class="mt-6 border-b border-neutral-200"></div>

      <nav class="mt-2 flex-1 pb-10">
        <ul class="flex flex-col">
          <li>
            <a
              href="/"
              class={`flex items-center gap-4 py-3.5 px-3 rounded-xl text-xl font-semibold transition-colors ${isActive("/") ? "bg-accent-primary/10 text-accent-primary" : "text-neutral-800"}`}
            >
              <span
                class={`text-sm font-sora w-6 shrink-0 ${isActive("/") ? "" : "text-neutral-400"}`}
                >01</span
              >
              Domů
            </a>
          </li>

          <!-- Služby accordion -->
          <li>
            <button
              type="button"
              data-accordion-toggle
              aria-expanded="false"
              class={`flex w-full items-center justify-between py-3.5 px-3 rounded-xl text-xl font-semibold transition-colors hover:text-accent-primary ${isActive("/sluzby") ? "bg-accent-primary/10 text-accent-primary" : "text-neutral-800"}`}
            >
              <span class="flex items-center gap-4">
                <span
                  class={`text-sm font-sora w-6 shrink-0 ${isActive("/sluzby") ? "" : "text-neutral-400"}`}
                  >02</span
                >
                Služby
              </span>
              <ChevronDown class="h-6 w-6 transition-transform duration-200" />
            </button>
            <ul data-accordion-panel class="hidden pb-2">
              {
                subLinks.map((link) => (
                  <li>
                    <a
                      href={link.href}
                      class={`block py-2.5 pl-10 text-base font-semibold transition-colors hover:text-accent-primary ${isActive(link.href) ? "text-accent-primary" : "text-neutral-800/80"}`}
                    >
                      {link.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </li>

          {
            links.map((link, i) => (
              <li>
                <a
                  href={link.href}
                  class={`flex items-center gap-4 py-3.5 px-3 rounded-xl text-xl font-semibold transition-colors ${isActive(link.href) ? "bg-accent-primary/10 text-accent-primary" : "text-neutral-800"}`}
                >
                  <span
                    class={`text-sm font-sora w-6 shrink-0 ${isActive(link.href) ? "" : "text-neutral-400"}`}
                  >
                    {String(i + 3).padStart(2, "0")}
                  </span>
                  {link.label}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>

      <div class="mt-auto border-t border-neutral-200 pt-6 space-y-4">
        <a
          href="tel:+420775736112"
          class="flex items-center justify-center gap-3 py-3 text-neutral-800"
        >
          <Phone class="w-5 h-5" />
          <span class="text-lg font-semibold">+420 775 736 112</span>
        </a>
        <Button variant="primaryDark" href="/kontakt" class="w-full" size="lg">
          Nezávazná poptávka
        </Button>
      </div>
    </div>
  </div>
</div>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const menu = document.querySelector("#mobile-menu-v2");
    const openBtn = document.querySelector("[data-menu-open]");
    const closeBtn = document.querySelector("[data-menu-close]");
    const backdrop = document.querySelector("[data-menu-backdrop]");

    if (!menu || !openBtn) return;

    const openMenu = () => {
      menu.setAttribute("data-open", "true");
      document.documentElement.classList.add("no-scroll");
      document.body.classList.add("no-scroll");
    };

    const closeMenu = () => {
      menu.setAttribute("data-open", "false");
      document.documentElement.classList.remove("no-scroll");
      document.body.classList.remove("no-scroll");
    };

    openBtn.addEventListener("click", openMenu);
    closeBtn?.addEventListener("click", closeMenu);
    backdrop?.addEventListener("click", closeMenu);

    // Accordion toggle
    const accordionToggle = menu.querySelector("[data-accordion-toggle]");
    const accordionPanel = menu.querySelector("[data-accordion-panel]");
    const accordionChevron = accordionToggle?.querySelector("svg");

    accordionToggle?.addEventListener("click", () => {
      const isOpen = accordionToggle.getAttribute("aria-expanded") === "true";
      accordionToggle.setAttribute("aria-expanded", String(!isOpen));
      accordionPanel?.classList.toggle("hidden");
      accordionChevron?.classList.toggle("rotate-180");
    });

    menu.addEventListener("click", (event) => {
      if (!(event.target instanceof Element)) return;
      if (event.target.closest("a[href],button:not([data-accordion-toggle]),[data-menu-close]"))
        closeMenu();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeMenu();
    });
  });
</script>
