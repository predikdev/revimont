---
import { ChevronDown } from "@lucide/astro";

const pathname = Astro.url.pathname;

const isActive = (href: string) => {
  if (href === "/") return pathname === "/";
  return pathname === href || pathname.startsWith(href + "/");
};

const subLinks = [
  { href: "/sluzby/elektroinstalace", label: "Elektroinstalace" },
  { href: "/sluzby/revize", label: "Revize" },
  { href: "/sluzby/opravy-montaze", label: "Opravy a montáže" },
];
---

<nav class="hidden lg:flex items-center gap-8">
  <a
    href="/"
    aria-current={isActive("/") ? "page" : undefined}
    class={`text-sm font-medium transition-colors hover:text-accent-primary ${isActive("/") ? "text-accent-primary" : "text-neutral-50/75"}`}
  >
    Domů
  </a>

  <div class="relative" data-dropdown>
    <button
      type="button"
      data-dropdown-trigger
      aria-expanded="false"
      aria-haspopup="true"
      class={`flex items-center gap-1 text-sm font-medium transition-colors hover:text-accent-primary ${isActive("/sluzby") ? "text-accent-primary" : "text-neutral-50/75"}`}
    >
      Služby
      <ChevronDown class="h-4 w-4 transition-transform duration-200" />
    </button>
    <div
      data-dropdown-panel
      class="absolute top-full left-0 mt-2 w-48 hidden bg-neutral-800 border border-neutral-700/40 rounded-lg shadow-lg shadow-neutral-900/30 py-2"
    >
      {
        subLinks.map((link) => (
          <a
            href={link.href}
            aria-current={isActive(link.href) ? "page" : undefined}
            class={`block px-4 py-2.5 text-sm transition-colors hover:text-accent-primary hover:bg-background/5 ${isActive(link.href) ? "text-accent-primary" : "text-neutral-50/75"}`}
          >
            {link.label}
          </a>
        ))
      }
    </div>
  </div>

  <a
    href="/o-nas"
    aria-current={isActive("/o-nas") ? "page" : undefined}
    class={`text-sm font-medium transition-colors hover:text-accent-primary ${isActive("/o-nas") ? "text-accent-primary" : "text-neutral-50/75"}`}
  >
    O nás
  </a>

  <a
    href="/reference"
    aria-current={isActive("/reference") ? "page" : undefined}
    class={`text-sm font-medium transition-colors hover:text-accent-primary ${isActive("/reference") ? "text-accent-primary" : "text-neutral-50/75"}`}
  >
    Reference
  </a>
</nav>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const dropdown = document.querySelector("[data-dropdown]");
    if (!dropdown) return;

    const trigger = dropdown.querySelector("[data-dropdown-trigger]");
    const panel = dropdown.querySelector("[data-dropdown-panel]");
    const chevron = trigger?.querySelector("svg");

    if (!trigger || !panel) return;

    const openDropdown = () => {
      trigger.setAttribute("aria-expanded", "true");
      panel.classList.remove("hidden");
      chevron?.classList.add("rotate-180");
    };

    const closeDropdown = () => {
      trigger.setAttribute("aria-expanded", "false");
      panel.classList.add("hidden");
      chevron?.classList.remove("rotate-180");
    };

    trigger.addEventListener("click", () => {
      const isOpen = trigger.getAttribute("aria-expanded") === "true";
      if (isOpen) {
        closeDropdown();
      } else {
        openDropdown();
      }
    });

    document.addEventListener("click", (e) => {
      if (!dropdown.contains(e.target as Node)) {
        closeDropdown();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeDropdown();
        (trigger as HTMLElement).focus();
      }
    });

    // Keyboard arrow navigation within dropdown
    const dropdownItems = Array.from(panel.querySelectorAll("a")) as HTMLAnchorElement[];

    (trigger as HTMLElement).addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "ArrowDown") {
        e.preventDefault();
        openDropdown();
        dropdownItems[0]?.focus();
      }
    });

    dropdownItems.forEach((item, index) => {
      item.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          dropdownItems[index + 1]?.focus();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          if (index === 0) {
            (trigger as HTMLElement).focus();
          } else {
            dropdownItems[index - 1]?.focus();
          }
        } else if (e.key === "Escape") {
          e.preventDefault();
          closeDropdown();
          (trigger as HTMLElement).focus();
        } else if (e.key === "Tab") {
          closeDropdown();
        }
      });
    });
  });
</script>
